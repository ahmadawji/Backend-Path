
# Personal Finance Tracker

This document provides an overview of the database schema and the triggers used in the Personal Finance Tracker project. The project is designed to manage user accounts, deposits, withdrawals, and transfers efficiently.

To have a clearer view of my database, below is an image of the physical data model ERD I have designed using [dbdiagram.io](https://dbdiagram.io/).
![image](https://github.com/ahmadawji/Backend-Path/assets/76648133/33762150-13f2-4d6e-8550-3bc252aabfaa)

  

## Database Schema

  

The database consists of the following tables:

  

### Table: users

  

| Column | Type | Constraints |
| --- | --- | --- |
| id | INTEGER | PRIMARY KEY, GENERATED BY DEFAULT AS IDENTITY |
| username | VARCHAR | UNIQUE, NOT NULL |
| email | VARCHAR | UNIQUE, NOT NULL |
| created_at | TIMESTAMP | DEFAULT (CURRENT_TIMESTAMP) |

  

### Table: accounts
| Column | Type | Constraints |
| --- | --- | --- |
| id | INTEGER | PRIMARY KEY, GENERATED BY DEFAULT AS IDENTITY |
| name | VARCHAR | NOT NULL |
| description | TEXT | |
| created_at | TIMESTAMP | DEFAULT (CURRENT_TIMESTAMP) |
| budget | FLOAT | NOT NULL DEFAULT 0 |
| user_id | INTEGER | FOREIGN KEY REFERENCES users(id) |

  

### Table: deposit_withdraw
| Column | Type | Constraints |
| --- | --- | --- |
| id | INTEGER | PRIMARY KEY, GENERATED BY DEFAULT AS IDENTITY |
| value | FLOAT | NOT NULL DEFAULT 0 |
| initialized_at | TIMESTAMP | DEFAULT (CURRENT_TIMESTAMP) |
| action_type | CHAR(1) | |
| category_id | INTEGER | FOREIGN KEY REFERENCES categories(id) |
| account_id | INTEGER | FOREIGN KEY REFERENCES accounts(id) |

  

### Table: categories
| Column | Type | Constraints |
| --- | --- | --- |
| id | INTEGER | PRIMARY KEY, GENERATED BY DEFAULT AS IDENTITY |
| title | VARCHAR | NOT NULL |
| description | TEXT | |
| created_at | TIMESTAMP | DEFAULT (CURRENT_TIMESTAMP) |

  

### Table: transfer

  

| Column | Type | Constraints |
| --- | --- | --- |
| id | INTEGER | PRIMARY KEY, GENERATED BY DEFAULT AS IDENTITY |
| value | FLOAT | NOT NULL DEFAULT 0 |
| sender_account | INTEGER | FOREIGN KEY REFERENCES accounts(id) |
| recipient_account | INTEGER | FOREIGN KEY REFERENCES accounts(id) |

  

### Table Relationships

  

-  `accounts.user_id` references `users.id` (many-to-one relationship)

-  `deposit_withdraw.category_id` references `categories.id` (one-to-many relationship)

-  `deposit_withdraw.account_id` references `accounts.id` (one-to-many relationship)

-  `transfer.sender_account` and `transfer.recipient_account` both reference `accounts.id` (one-to-many relationship)

  

## Constraints

  

-  `accounts.budget`, `deposit_withdraw.value`, and `transfer.value` must be non-negative values (check constraints).

  

## Triggers

  

### Trigger for `deposit_withdraw`

  

This trigger ensures that deposits and withdrawals update the `budget` of the associated account accordingly.

  

### Function: handle_deposit_withdrawal

  

```sql

CREATE OR
REPLACE FUNCTION handle_deposit_withdrawal () RETURNS TRIGGER AS $$
BEGIN
    IF (SELECT budget FROM accounts WHERE id = NEW.account_id) < NEW.value AND NEW.action_type = 'W' THEN
            RAISE EXCEPTION 'Insufficient funds in sender account.';
        ELSE
            IF NEW.action_type = 'W' THEN
            -- Handle withdrawal
            UPDATE accounts
            SET budget = budget - NEW.value
            WHERE id = NEW.account_id;

            ELSIF NEW.action_type = 'D' THEN
            -- Handle deposit
            UPDATE accounts
            SET budget = budget + NEW.value
            WHERE id = NEW.account_id;

            ELSE
            -- Prevent invalid action types
            RAISE EXCEPTION 'Invalid action_type: %. It must be either W (withdrawal) or D (deposit).', NEW.action_type;
            END IF;
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

```

  

### Trigger: after_insert_deposit_withdrawal

  

```sql

CREATE TRIGGER after_insert_deposit_withdrawal
AFTER INSERT ON deposit_withdraw FOR EACH ROW
EXECUTE FUNCTION handle_deposit_withdrawal ();

```

  

### Trigger for `transfer`

  

This trigger handles the transfer of funds between accounts, ensuring that the sender has sufficient funds and that the transfer is valid.

  

### Function: handle_transfer

  

```sql
CREATE OR
REPLACE FUNCTION handle_transfer () RETURNS TRIGGER AS $$
BEGIN
    IF NEW.sender_account = NEW.recipient_account THEN
        RAISE EXCEPTION 'Invalid transfer. Sender account cannot transfer to itself.';
    ELSE
        -- Ensure sender has sufficient budget
        IF (SELECT budget FROM accounts WHERE id = NEW.sender_account) < NEW.value THEN
            RAISE EXCEPTION 'Insufficient funds in sender account.';
        ELSE
            -- Subtract from sender's budget
            UPDATE accounts
            SET budget = budget - NEW.value
            WHERE id = NEW.sender_account;

            -- Add to recipient's budget
            UPDATE accounts
            SET budget = budget + NEW.value
            WHERE id = NEW.recipient_account;
        END IF;
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

```

  

### Trigger: after_insert_transfer

  

```sql

CREATE TRIGGER after_insert_transfer
AFTER INSERT ON transfer FOR EACH ROW
EXECUTE FUNCTION handle_transfer ();

```

  

These triggers ensure that every deposit, withdrawal, and transfer operation is reflected in the `budget` field of the `accounts` table, maintaining the financial integrity of the system.
